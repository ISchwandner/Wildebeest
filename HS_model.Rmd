---
title: "Habitat_Suitability_Model_10-13"
author: "Imogen Schwandner -2671952S"
date: '2022-06-08'
output: html_document
---

A habitat-suitability model based on wildebeest GPS tracking data from 2010-2013. Built in a logistic regression framework with a logit link, based on location fixes as presences and pseudo-absences. Pseudo absences will be randomly generated i=within a buffer of the maximum obsoverd step length of any animal in the data set.

```{r message=FALSE, warning=FALSE}
library(rgeos)
library(rgdal)
library(sp)
library(adehabitatHR)
library(dplyr)
library(raster)
library(sf)
library(amt)
#library(lme4)
```

1. Load wildebeest data and covariate layers

```{r}
load("WB_and_Covariates_data.RData")
```

2. Create buffers for pseudo-absences

Buffer size chosen as the maximum observed step length over 3 hour period for each animal in the data set

2.1. Calculate maximum 3h step length for each individual

```{r}
### 2.1.1. Load and reformat data
# convert spatial points object to dataframe
WBS <- as.data.frame(WBS) #must be dataframe

# reformat date column as POSIX
WBS$datetime <- as.POSIXct(WBS$Date, format="%d/%m/%Y %H:%M", tz='GMT')

### 2.1.1. Create Trajectories
# convert points into a trajectory using 'adehabitat' package
WBtraj <- as.ltraj(cbind(WBS$x, WBS$y),date = WBS$datetime,id = (WBS$AID))

### 2.1.2. Create large combined trajectories dataframe
# Create a dataframe to holds all of the contents of WBtraj 
# Put first individual into the dataframe
WBtraj.df <- data.frame(WBtraj[[1]], id = attr(WBtraj[[1]], "id"))

# Use a for loop to fill the larger dataframe with the rest of the trajectories
for(i in 2:length(WBtraj)) {
  WBtraj.df <- rbind(WBtraj.df, 
                    data.frame(WBtraj[[i]],
                    id = attr(WBtraj[[i]], "id")))
}

# remove NA's (final location has no distance displaced thereafter)
WBtraj.df <- subset(WBtraj.df, dist != "NA")

### 2.1.3. Obtain maximum distance displaced
#obtain maximum distance displaced total
max(WBtraj.df$dist)
# 27446.55 ~ 27.5 km

### 2.1.4. Maximum distance displaced over 3 h PER INDIVIDUAL
# create object with individual ID and maximum distance displaced
indiv.max.dist <- WBtraj.df %>% group_by(id) %>% summarise(maxdist = max(dist))
#calculate mean
mean(indiv.max.dist$maxdist)
#10968.45 m ~ 11 km
# calculate median
median(indiv.max.dist$maxdist)
#7903.08 m  ~  8 km

### 2.1.5. Create vector of individual buffer sizes
sizes <- c(indiv.max.dist$maxdist)

```

2.2. Creating an individual buffer corresponding to the respective maximum observed step length over a 3 h interval (for the availability points of each individual)
```{r}
# project data - convert to spatialpoints df
coordinates(WBS) <- ~x+y
proj4string(WBS) <- crs

# split WBS into list of dataframes for each individual
WBS_indiv <- split(WBS, WBS$AID)


# create an empty list for the results
Buffer_list <- list()

# For loop to run through every item in the list of individuals, to create a buffer with the extracted maximum observed step length corresponding to each individual
for (i in 1:length(sizes)) {
  
  #iterate through
  Buffer_list[[i]] <- rgeos::gBuffer(WBS_indiv[[i]], 
                                byid = TRUE, 
                                width = sizes[i])
}

# Unlist buffers into single spatial object
#Buffers <- rbind(unlist(Buffer_list))
```

2.3. Generating 100 random points within each buffer as pseudo-absences

```{r}

```

_. Editing WBS data to keep only columns of interest for HBS model

```{r}
WBS@data <- WBS@data[, c(1,10:11,22)]
```

_. Extracting Covariates for Presence-Points

_._. Creating a raster stack

WB presence data already have NDVI and DNDVI extracted and attached

```{r}
WBS_stack <- stack(anthro, D_river, D_roadT1, D_roadT5, D_wood, TWI)
```

_._ Extract Covariates for WBS _Presence Points

```{r}
rasValue <- extract(WBS_stack, WBS)
```

_._ Convert to data frame and join raster Values

```{r}
WBS_RSF <- as.data.frame(WBS)

WBS_RSF <- cbind(WBS_RSF, rasValue)
```

```{r}
# Create P/A column with value 1
WBS_RSF$PA <- 1
```

_._ Extract Covariates for Pseudo-Absences


-.- Add pseudo-absences and covariates to WBS_RSF
(might need to reorder and change some columns)

_._ Build a habitat suitability model

```{r}
M <- glmer(PA ~ scale(indvi) + sclae(dndvi) + scale(TWI) + scale(D_wood) + scale(D_river) + scale(D_rdt1) + scale(D_rdt5) + scale(anthro) + scale(I(D_wood^2)) + scale(I(D_river)^2) + scale(I(D_rdt1)^2) + scale(I(D_rdt5)^2), data = WBS_RSF, family = binomial(link="logit"))
```

